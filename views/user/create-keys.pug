extends ../layout

block content
  .container
    .row.justify-content-center
      .col-md-8.col-lg-8
        .text-center.mt-5
          img(src="/images/logo.png" alt="BananaTransfer" style="width:80px;")
          h2.mt-3.mb-4 Generate new Key-Pair and Master-Password
        if error
          .alert.alert-danger.text-center= error

        // Generate Private Key Button
        .mb-3
          .fw-semibold.mb-1 Generate new Private and Public Key
          .row.align-items-center
            .col-auto.col-lg-4
              button.btn.btn-outline-secondary(type="button" onclick="generatePrivateKey()")
                i.bi.bi-key.me-1
                | Generate Key-Pair
            .col
              div.small.text-muted
                | The Private and Public Key will be used to encrypt the files shared with you.        
          label.mt-3.form-label(for="publicKeyField") Public Key
          .input-group.mb-2.mx-auto(style="max-width:100%")
            input.form-control(type="text", id="publicKeyField", value=publicKey, readonly)
            button.btn.btn-outline-secondary(type="button", id="copyPublicKeyBtn", onclick="copyToClipboard('publicKeyField', 'copyPublicKeyBtn')")
              i.bi.bi-clipboard
          div.small.text-muted.mb-2
            | This is your public key. It will be automatically shared with others so they can send you files.

        // Generate new Master-Password
        .mb-3
          .fw-semibold.mb-1 Generate new Master-Password
          .row.align-items-center
            .col-auto.col-lg-4
              button.btn.btn-outline-secondary(type="button" onclick="generateMasterPassword()")
                i.bi.bi-shield-lock.me-1
                | Generate Master-Password
            .col
              div.small.text-muted
                | The Master-Password is used to encrypt your private Key and store it securely on your organization's server.
          label.mt-3.form-label(for="masterPasswordField") Master Password
          .input-group.mb-2.mx-auto(style="max-width:100%")
            input.form-control(type="text", id="masterPasswordField", value=password, readonly, style="min-width:300px; word-break:break-all;")
            button.btn.btn-outline-secondary(type="button", id="copyMasterPasswordBtn", onclick="copyToClipboard('masterPasswordField', 'copyMasterPasswordBtn')")
              i.bi.bi-clipboard
          div.small.text-muted
            | Please make sure you store it in your Password-Manager.
            | Before downloading and decrypting files that were shared with you, you will be asked for this Master-Password.

        // Encrypt and Save Encrypted Keys
        .mb-3
          .fw-semibold.mb-1 Encrypt and Save new Keys
          div.small.text-muted
          | Important: This will override your current keys stored on the server. Files that were previously shared with you, wont be accessible anymore with the new key
          .row.align-items-center.mt-3
            .col-auto.col-lg-4
              button.btn.btn-outline-secondary.mb-1(type="button" onclick="encryptAndSaveKey()")
                i.bi.bi-upload.me-1
                | Encrypt and save Keys
            .col
              div.small.text-muted
                | Your private key will be encrypted with your master-password and stored on your organizations server.
                
  script.
    function copyPassword() {
      const password = "#{password}";
      navigator.clipboard.writeText(password);
      const btn = document.getElementById('copyBtn');
      btn.innerText = "Copied!";
      setTimeout(() => { btn.innerText = "Copy to clipboard"; }, 1500);
    }

    function copyToClipboard(inputId, btnId) {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      navigator.clipboard.writeText(input.value);
      btn.innerHTML = '<i class="bi bi-clipboard-check"></i>';
      setTimeout(() => { btn.innerHTML = '<i class="bi bi-clipboard"></i>'; }, 1500);
    }